### 分布式服务追踪
#### 理论基础
Google的一篇论文：Dapper, a Large-Scale Distributed Systems Tracing Infrastructure  
英文版：https://storage.googleapis.com/pub-tools-public-publication-data/pdf/36356.pdf  
中文翻译：https://zhuanlan.zhihu.com/p/38255020

#### 是什么?功能有有哪些？
分布式链路追踪就是将分布式请求还原成调用链路，并将分布式请求的调用情况集中展示，比如各个服务节点上的耗时、请求具体到达哪台机器上、每个服务节点的请求状态等等。主要包含以下功能：
- 故障快速定位：通过调用链跟踪，一次请求的逻辑轨迹可以完整清晰的展示出来。开发中可以在业务日志中添加调用链ID，可以通过调用链结合业务日志快速定位错误信息。
- 各个调用环节的性能分析：在调用链的各个环节分别添加调用时延，可以分析系统的性能瓶颈，进行针对性的优化。通过分析各个环节的平均时延，QPS等信息，可以找到系统的薄弱环节，对一些模块做调整，如数据冗余等。
- 数据分析：调用链绑定业务后查看具体每条业务数据对应的链路，可以得到用户的行为路径，经过了哪些服务器上的哪个服务，汇总分析应用在很多业务场景。
- 生成服务调用拓扑图：通过可视化分布式系统的模块和他们之间的相互联系来理解系统拓扑。点击某个节点会展示这个模块的详情，比如它当前的状态和请求数量。
#### 为什么要用分布式链路追踪系统？
随着互联网业务的发展，系统也变得日益复杂，通常我们一个系统会由几十上百个服务组成；一次请求的完成，需要经过很多个服务；当出现错误或者性能出现瓶颈的时候，传统的方式需要通过查看各个服务的日志来定位问题，这样效率太慢了；通过分布式链路追踪服务，我们能够很快速的定位到问题发生在哪个环节。  

#### 应用场景
当我们的系统架构比较复杂，服务调用拓扑比较复杂的情况下，我们可以通过分布式链路追踪系统来快速定位问题、生成服务调用拓扑图等。

#### 如何使用？

#### 如何设计
分布式链路追踪系统的设计思路：  
- 分布式链路追踪系统的设计目标
  1. 低侵入性，应用透明：作为非业务组件，应当尽可能少侵入或者无侵入其他业务系统，对于使用方透明，减少开发人员的负担
  2. 性能损耗低：服务调用埋点本身会带来性能损耗，这就需要调用跟踪的低损耗，实际中还会通过配置采样率的方式，选择一部分请求去分析请求路径
  3. 可伸缩性：作为分布式系统的组件之一，一个优秀的调用跟踪系统必须支持分布式部署，具备良好的可扩展性
- 埋点和生成日志：埋点即系统在当前节点的上下文信息，可以分为客户端埋点、服务端埋点，以及客户端和服务端双向型埋点；并把埋点日志写入本地日志文件中。
- 抓取和存储日志：日志的采集和存储有许多开源的工具可以选择，一般来说，会使用离线+实时的方式去存储日志，主要是分布式日志采集的方式。典型的解决方案如Flume结合Kafka等MQ。
- 分析和统计调用链数据：一条调用链的日志散落在调用经过的各个服务器上，首先需要按 TraceId 汇总日志，然后按照RpcId 对调用链进行顺序整理。用链数据不要求百分之百准确，可以允许中间的部分日志丢失。
- 计算和展示：汇总得到各个应用节点的调用链日志后，可以针对性的对各个业务线进行分析。需要对具体日志进行整理，进一步储存在HBase或者关系型数据库中，可以进行可视化的查询。

参考文章：https://www.cnblogs.com/zhangs1986/p/8879744.html

### openTracing
#### 是什么，在什么背景下产生的
目前各种分布式追踪系统层出不穷，且有着相似的API语法，但各种语言的开发人员依然很难将他们各自的系统和特定的分布式追踪系统进行整合；在此背景下，OpenTracing规范出现了；OpenTracing通过提供平台无关、厂商无关的API，使得开发人员能够方便的添加（或更换）追踪系统的实现。OpenTracing通过定义的API，可实现将监控数据记录到一个可插拔的追踪系统上。

参考文章：  
OpenTracing中文：https://wu-sheng.gitbooks.io/opentracing-io/content/
